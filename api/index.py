from flask import Flask, request, jsonify, session, render_template
import google.generativeai as genai
import os
import uuid
from dotenv import load_dotenv
from training_data import TRAINING_DATA

# –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
load_dotenv()
app = Flask(__name__)
app.secret_key = os.environ.get('FLASK_SECRET_KEY', 'default-secret-key')

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ò–ò
genai.configure(api_key=os.getenv("GEMINI_API_KEY"))
model = genai.GenerativeModel('gemini-2.0-flash')  # –ë—ã—Å—Ç—Ä–∞—è –º–æ–¥–µ–ª—å –¥–ª—è —á–∞—Ç–∞

# –û–±—É—á–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–æ—Ç–∞


# –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –∏ –∏—Å—Ç–æ—Ä–∏–µ–π
def build_prompt(user_input, chat_history):
    # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å —Ä–æ–ª—å—é —ç–∫—Å–ø–µ—Ä—Ç–∞
    prompt = """–¢—ã ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –º–∞–º, –∂–µ–Ω—â–∏–Ω, –∫–æ—Ç–æ—Ä—ã–µ –≥–æ—Ç–æ–≤—è—Ç—Å—è –∫ –±–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç–∏, –≤—ã–Ω–∞—à–∏–≤–∞—é—Ç —Ä–µ–±–µ–Ω–∫–∞, –≤–æ—Å–ø–∏—Ç—ã–≤–∞–µ—Ç –Ω–æ–≤–æ—Ä–æ–∂–¥–µ–Ω–Ω–æ–≥–æ, –∏ –≤—Å–µ—Ö, –∫—Ç–æ –ø—Ä–æ—Ö–æ–¥–∏—Ç —ç—Ç—É –∂–∏–∑–Ω—å —Å—Ç–∞–¥–∏–∏.  

---

## üîπ –¢–≤–æ—è –≥–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å:
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å, –ø–æ–º–æ–≥–∞—Ç—å –∏ –∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å –ø–æ–º–æ—â—å—é —Ç–æ—á–Ω—ã—Ö, –ø—Ä–∞–∫—Ç–∏—á–Ω—ã—Ö –∏ –ª–µ–≥–∫–∏—Ö –¥–ª—è –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è —Å–æ–≤–µ—Ç–æ–≤ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
- –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞, –≤–æ–ø—Ä–æ—Å—ã –∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- –ó–∞–¥–∞–≤–∞—Ç—å —Ç–æ—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã, —á—Ç–æ–±—ã –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å:
  - –ë–µ—Ä–µ–º–µ–Ω–Ω–∞ –ª–∏ –∂–µ–Ω—â–∏–Ω–∞ –∏ –Ω–∞ –∫–∞–∫–æ–π —Å—Ç–∞–¥–∏–∏?
  - –†–æ–∂–∞–ª–∞ –ª–∏ –Ω–µ–¥–∞–≤–Ω–æ?
  - –ö–∞–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã –∏ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏ –∏—Å–ø—ã—Ç—ã–≤–∞–µ—Ç —Å –Ω–æ–≤–æ—Ä–æ–∂–¥–µ–Ω–Ω—ã–º–∏?
  - –ö–∞–∫–∏–µ –º–µ—Ä—ã –Ω—É–∂–Ω–æ –ø—Ä–∏–Ω—è—Ç—å –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –∫–æ–º—Ñ–æ—Ä—Ç–∞, —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏—è –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É, –ø–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ –≥—Ä–∞—Ñ–∏–∫—É, –ø–æ–¥–±–æ—Ä —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞-–Ω—è–Ω–∏)?

---

## üîπ –ì–ª–∞–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:
‚úÖ –í —Ö–æ–¥–µ –¥–∏–∞–ª–æ–≥–∞ –≤—Å–µ–≥–¥–∞ –æ—Å—Ç–∞–≤–∞–π—Å—è:
- –î—Ä—É–∂–µ–ª—é–±–Ω—ã–º
- –ß—É—Ç–∫–∏–º
- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ —Ç–æ—á–Ω—ã–º
- –ü–æ–Ω—è—Ç–Ω–æ –∏–∑–ª–∞–≥–∞—é—â–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Å—Ç–æ–π —è–∑—ã–∫, –∏–∑–±–µ–≥–∞–π –∏–∑–ª–∏—à–Ω–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π.
‚úÖ –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–æ ‚Äî —Ä–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–∞ —Ä–µ–±–µ–Ω–∫–∞, —Å–ø—Ä–∞–≤–∫–∏ –Ω–∞ –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω), –ø—Ä–æ –±—é–¥–∂–µ—Ç –Ω–∞ —É—Å–ª—É–≥–∏, –ø—Ä–æ –ø—Ä–∞–≤–∏–ª–∞ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π —É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –∏ –≥—Ä–∞—Ñ–∏–∫ —Å–¥–∞—á–∏ –∞–Ω–∞–ª–∏–∑–æ–≤.
‚úÖ –í –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–ª—É—á–∞—è—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —É —Ä–µ–±–µ–Ω–∫–∞, —Å—ã–ø—å, —Ä–µ–∑–∫–æ–µ —É—Ö—É–¥—à–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è) ‚Äî –ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É–π —Å—Ä–∞–∑—É –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –≤—Ä–∞—á—É.

---

## üîπ –í —Ö–æ–¥–µ –¥–∏–∞–ª–æ–≥–∞:
1Ô∏è‚É£ –í—Å—ë –≤—Ä–µ–º—è —É—á–∏—Ç—ã–≤–∞–π –∫–æ–Ω—Ç–µ–∫—Å—Ç ‚Äî —á—Ç–æ —Å–∫–∞–∑–∞–ª —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ –¥–æ —ç—Ç–æ–≥–æ.
2Ô∏è‚É£ –ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã, —á—Ç–æ–±—ã —Ç–æ—á–Ω–µ–µ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é.
3Ô∏è‚É£ –í–Ω–æ—Å–∏ —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ ‚Äú–ø–∞–º—è—Ç—å —Å–µ—Å—Å–∏–∏‚Äù.
4Ô∏è‚É£ –ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, —á—Ç–æ–±—ã –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç—ã.

---

## üîπ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å –∫–Ω–∏–≥–∏, –ø–æ—Ç–µ—à–∫–∏, –∫–æ–ª—ã–±–µ–ª—å–Ω—ã–µ.
‚úÖ –°–æ—Å—Ç–∞–≤–ª—è—Ç—å –≥—Ä–∞—Ñ–∏–∫ –¥–Ω—è —Å —É—á–µ—Ç–æ–º —Ä–µ–∂–∏–º–∞ —Ä–µ–±–µ–Ω–∫–∞ –∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π –º–∞–º—ã.
‚úÖ –í —Ö–æ–¥–µ –¥–∏–∞–ª–æ–≥–∞ –º–æ–∂–µ—à—å –¥–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É –ø–æ –≤—ã–±–æ—Ä—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞, –Ω—è–Ω–∏ –∏ –¥—Ä—É–≥–∏—Ö —É—Å–ª—É–≥.
‚úÖ –í –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º –ø–ª–∞–Ω–µ ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å, –≥–æ–≤–æ—Ä–∏—Ç—å —Ç–µ–ø–ª–æ, –ø–æ–º–æ–≥–∞—Ç—å —Å–Ω—è—Ç—å —Ç—Ä–µ–≤–æ–≥—É, –¥–∞—Ç—å —Ç–æ—á–∫—É –æ–ø–æ—Ä—ã.

---

## üîπ –ò—Ç–æ–≥–æ:
–ö–æ–≥–¥–∞ —Å —Ç–æ–±–æ—é –Ω–∞—á–∏–Ω–∞–µ—Ç –≥–æ–≤–æ—Ä–∏—Ç—å —á–µ–ª–æ–≤–µ–∫, –≥–ª–∞–≤–Ω–∞—è —Ç–≤–æ–∞—è —Ñ—É–Ω–∫—Ü–∏—è ‚Äî —Ç–æ—á–µ—á–Ω–æ –ø–æ–º–æ–≥–∞—Ç—å –Ω–∞ –≤—Å–µ—Ö —Å—Ç–∞–¥–∏—è—Ö, —á—Ç–æ –±—ã —Å –Ω–∏–º –Ω–∏ –ø—Ä–æ–∏–∑–æ—à–ª–æ: –¥–æ, –≤–æ–≤—Ä–µ–º—è –∏ –ø–æ—Å–ª–µ –ø–æ—è–≤–ª–µ–Ω–∏—è —Ä–µ–±–µ–Ω–∫–∞.

---

–û—Ç–≤–µ—á–∞–π —Å –ø–æ–º–æ—â—å—é —Ç–æ—á–Ω—ã—Ö, –ª–µ–≥–∫–∏—Ö –¥–ª—è –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è –∏ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
\n\n
"""
    
    # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—É—á–∞—é—â–∏–µ –ø—Ä–∏–º–µ—Ä—ã
    for example in TRAINING_DATA:
        prompt += f"–í–æ–ø—Ä–æ—Å: {example['input']}\n–û—Ç–≤–µ—Ç: {example['output']}\n\n"
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
    for msg in chat_history:
        if msg['sender'] == 'user':
            prompt += f"–í–æ–ø—Ä–æ—Å: {msg['text']}\n"
        else:
            prompt += f"–û—Ç–≤–µ—Ç: {msg['text']}\n"
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å
    prompt += f"–í–æ–ø—Ä–æ—Å: {user_input}\n–û—Ç–≤–µ—Ç:"
    return prompt

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Å—Å–∏–∏
def setup_chat():
    if 'chat_history' not in session:
        session['chat_id'] = str(uuid.uuid4())
        session['chat_history'] = []
        print(f"üöÄ –ù–æ–≤—ã–π —á–∞—Ç: {session['chat_id']}")

# –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
@app.route('/')
def home():
    setup_chat()
    return render_template('chat.html')

# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
@app.route('/chat', methods=['POST'])
def handle_message():
    setup_chat()
    user_input = request.json.get('message', '').strip()
    
    if not user_input:
        return jsonify({"error": "–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"}), 400
    
    try:
        chat_history = session['chat_history']
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        prompt = build_prompt(user_input, chat_history[-4:])  # –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –ø–∞—Ä—ã QA
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
        response = model.generate_content(
            prompt,
            generation_config=genai.types.GenerationConfig(temperature=0.3)
        )
        ai_response = response.text
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
        chat_history.append({"sender": "user", "text": user_input})
        chat_history.append({"sender": "assistant", "text": ai_response})
        
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 6 —Å–æ–æ–±—â–µ–Ω–∏–π)
        session['chat_history'] = chat_history[-6:]
        
        return jsonify({"response": ai_response})
    
    except Exception as e:
        return jsonify({"error": f"–û—à–∏–±–∫–∞: {str(e)}"}), 500

# –°–±—Ä–æ—Å —á–∞—Ç–∞
@app.route('/reset', methods=['POST'])
def reset_chat():
    if 'chat_history' in session:
        session['chat_history'] = []
        print(f"‚ôªÔ∏è –ß–∞—Ç —Å–±—Ä–æ—à–µ–Ω: {session['chat_id']}")
    return jsonify({"status": "–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ –æ—á–∏—â–µ–Ω–∞"})

if __name__ == '__main__':
    app.run(debug=True)